const { Telegraf } = require('telegraf');
const config = require('./config');
const bot = new Telegraf(config.bot_token);
const fs = require('fs');
const images =  require('./dataform.js');

const userResponses = {};
let userCounter = 1;

bot.start((ctx) => {
    const userId = ctx.message.from.id;
    userResponses[userId] = { step: 0 };
    ctx.replyWithPhoto(images.images.begin, 'Привет! Мы Тим и Фича, техно-котики из Ингосстраха! Круто, что ты на конференции Enterprise Agile Russia 2024. В честь этого события приглашаем тебя поиграть в Ingo Agile Game.');


    setTimeout(() => {
        ctx.reply('Пожалуйста, напиши свое ФИО');
    }, 500);
});

bot.on('text', (ctx) => {
    const userId = ctx.message.from.id;
    const userState = userResponses[userId];

    console.log(`Получено сообщение от пользователя ${userId}: ${ctx.message.text}`);
    console.log(`Текущее состояние пользователя:`, userState);

    if (!userState) {
        ctx.reply('Пожалуйста, используйте /start, чтобы начать.');
        return;
    }

    if (userState.step === 0) {
        userState.name = ctx.message.text;
        userState.step = 1;
//        ctx.reply('Класс! Тогда продолжим общение. Я Тим - разработчик, а я Фича - аналитик. Мы работаем по Agile и этот подход уже стал неотъемлемой частью всех ИТ-процессов в компании.');

//        setTimeout(() => {
        ctx.replyWithSticker('CAACAgIAAxkBAUjM4GcORbJmZvA2cRY81mIYmRVhSW-BAAKEXwACrhN5SOhZDYckq4RENgQ');
//            ctx.replyWithPhoto(images.images.work1, 'А где работаешь ты и чем занимаешься?');
//        }, 500);
        setTimeout(() => {
           ctx.replyWithSticker('CAACAgIAAxkBAUjM3WcORbCrHaJH8B8TcLq26Wbr8mXAAAKVYwAC0TJ5SFDo5EP0ub9zNgQ');
//            ctx.replyWithPhoto(images.images.work2, 'А где работаешь ты и чем занимаешься?');
        }, 500);
        setTimeout(() => {
           ctx.reply('Напиши пару слов о своей работе');
        }, 1000);
    } else if (userState.step === 1) {
        userState.position = ctx.message.text;
        userState.step = 2;
        ctx.reply('Звучит здорово! Давай обменяемся контактами. Наш адрес: hr@ingos.ru');

        setTimeout(() => {
            ctx.replyWithPhoto(images.images.contacts, {caption: 'Укажи свои контакты (email или номер телефона)'});
        }, 500);
    } else if (userState.step === 2) {
        userState.contacts = ctx.message.text;
        userState.step = 3;

        userState.uniqueId = userCounter++;

        const userData = `Номер: ${userState.uniqueId}, Имя: ${userState.name}, Должность: ${userState.position}, Контакты: ${userState.contacts}\n`;
        fs.appendFile('htdocs/answers/user_responses.txt', userData, (err) => {
            if (err) {
                console.error('Ошибка записи файла:', err);
                ctx.reply('Произошла ошибка при сохранении ваших данных.');
                return;
            } else {
                console.log('Ответы сохранены.');
            }
        });

//        ctx.reply(`Спасибо за ваши ответы! Вот что вы указали:\nИмя: ${userState.name}\nДолжность: ${userState.position}\nКонтакты: ${userState.contacts}`);
        ctx.reply('Вау! Поздравляю! Теперь ты участник розыгрыша супер-призов, который состоится в 14:00 и в 16:15 возле стенда "Ингосстрах"');
        
        setTimeout(() => {
            ctx.reply(`И прямо сейчас подходи к нашим стендистам и получай наклейки за знакомство :)`);
        }, 500);

        setTimeout(() => {
            ctx.reply(`Твой уникальный номер: ${userState.uniqueId}`);
        }, 1000);
    }
});

// Запуск бота
bot.launch();

